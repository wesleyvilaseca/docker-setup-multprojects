# ============================================
# Configurações Anti-Deadlock PostgreSQL
# ============================================
# Este arquivo contém configurações otimizadas para prevenir deadlocks
# O arquivo é aplicado automaticamente quando o container inicia

# ============================================
# CONFIGURAÇÕES DE DEADLOCK
# ============================================
deadlock_timeout = 5s                    # Aumentado de 1s para 5s (padrão: 1s)
log_lock_waits = on                      # Log de esperas de lock
log_deadlocks = on                       # Log de deadlocks no log do PostgreSQL

# ============================================
# CONFIGURAÇÕES DE TIMEOUT
# ============================================
lock_timeout = 30s                       # Timeout para locks (30 segundos)
statement_timeout = 300s                 # Timeout para statements (5 minutos)
idle_in_transaction_session_timeout = 300s  # Timeout para transações idle (5 minutos)

# ============================================
# CONFIGURAÇÕES DE CONEXÃO
# ============================================
max_connections = 200                    # Máximo de conexões simultâneas

# ============================================
# CONFIGURAÇÕES DE MEMÓRIA
# ============================================
shared_buffers = 256MB                   # Buffer compartilhado (25% da memória)
work_mem = 4MB                          # Memória por operação de ordenação/hash
maintenance_work_mem = 64MB             # Memória para operações de manutenção
effective_cache_size = 1GB              # Cache efetivo estimado

# ============================================
# CONFIGURAÇÕES DE LOG
# ============================================
log_min_duration_statement = 1000        # Log queries que demoram mais de 1s
log_lock_waits = on                      # Log quando processos esperam por locks
log_deadlocks = on                       # Log quando deadlocks são detectados

# ============================================
# CONFIGURAÇÕES DE PERFORMANCE
# ============================================
random_page_cost = 1.1                   # Custo de página aleatória (otimizado para SSD)
effective_io_concurrency = 200            # I/O concorrente efetivo
max_worker_processes = 8                 # Máximo de processos worker
max_parallel_workers_per_gather = 4      # Máximo de workers paralelos por gather
max_parallel_workers = 8                  # Máximo de workers paralelos

# ============================================
# CONFIGURAÇÕES DE WAL (Write-Ahead Logging)
# ============================================
wal_level = replica                      # Nível de WAL para replicação
max_wal_size = 1GB                       # Tamanho máximo do WAL
min_wal_size = 80MB                      # Tamanho mínimo do WAL
checkpoint_completion_target = 0.9       # Alvo de completude do checkpoint

